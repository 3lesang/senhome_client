---
export const prerender = false;

import AddToCartButton from "@/components/add-to-cart-button";
import BuyNowButton from "@/components/buy-now-button";
import ImageGallery from "@/components/image-gallery";
import ProductOptionSelect from "@/components/product-option-select";
import { StarRating } from "@/components/star-rating";
import { Badge } from "@/components/ui/badge";
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import { Button, buttonVariants } from "@/components/ui/button";
import Main from "@/layouts/main.astro";
import {
  IMAGE_COLLECTION,
  pb,
  PRODUCT_COLLECTION,
  PRODUCT_VARIANT_ATTRIBUTES_COLLECTION,
} from "@/lib/pocketbase";
import { cn, convertImageUrl, formatAttributes, formatVND } from "@/lib/utils";
import "@/styles/content.css";
import { Share2Icon, ShieldCheckIcon } from "lucide-react";

const { slug } = Astro.params;

let product = null;
try {
  product = await pb
    .collection(PRODUCT_COLLECTION)
    .getFirstListItem(`slug = "${slug}"`, {
      expand: "category",
    });
} catch (error) {}

async function getProductOptions(id?: string) {
  const data = await pb
    .collection(PRODUCT_VARIANT_ATTRIBUTES_COLLECTION)
    .getFullList({
      filter: `variant.product = "${id}"`,
      expand: "variant,attribute,attribute_value",
      sort: "-attribute.order",
    });

  return formatAttributes(data);
}

const options = await getProductOptions(product?.id);

const images = await pb.collection(IMAGE_COLLECTION).getFullList({
  filter: `product="${product?.id}"||variant.product="${product?.id}"`,
});

const galleryData = images.map((item) => ({
  id: item?.variant,
  image: convertImageUrl(item) || "",
}));
---

<Main title={product?.name}>
  <div class="">
    <div class="lg:max-w-6xl mx-auto">
      <Breadcrumb className="py-4 px-2 lg:px-0">
        <BreadcrumbList>
          <BreadcrumbItem>
            <BreadcrumbLink
              href="/"
              className="hover:underline hover:text-blue-500"
            >
              Trang chủ
            </BreadcrumbLink>
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbLink
              href="/components"
              className="hover:underline hover:text-blue-500"
              >{product?.expand?.category?.name}</BreadcrumbLink
            >
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbPage className="line-clamp-1"
              >{product?.name}</BreadcrumbPage
            >
          </BreadcrumbItem>
        </BreadcrumbList>
      </Breadcrumb>
      <div class="grid grid-cols-12 gap-4">
        <div class="col-span-12 lg:col-span-7">
          <ImageGallery client:only data={galleryData || []} />
        </div>
        <div class="col-span-12 lg:col-span-5 space-y-4 px-4 lg:px-0">
          <div class="space-y-1">
            <div>
              <p class="text-xl font-medium inline">{product?.name}</p>
              <Button size="icon" variant="ghost" className="cursor-pointer"
                ><Share2Icon /></Button
              >
            </div>

            <div class="space-x-4">
              <span class="space-x-1">
                <StarRating rating={3} className="inline" />
                <span class="text-sm font-bold text-blue-500">404 đánh giá</span
                >
              </span>

              <span class="text-sm">
                <span class="text-gray-600">Đã bán</span>
                <span class="font-bold">1k</span>
              </span>
            </div>
            {
              product?.discount > 0 && (
                <p class="text-gray-600 text-sm">
                  <Badge className="font-bold">
                    -{product?.discount * 100}%
                  </Badge>
                  <span class="line-through">{formatVND(product?.price)}</span>
                </p>
              )
            }
            <p class="text-xl font-bold">
              {formatVND(product?.price - product?.price * product?.discount)}
            </p>
          </div>
          <div class="space-x-4 text-sm text-gray-600">
            <span>Vận chuyển</span>
            <span class=""> </span>
          </div>
          <div class="space-x-4 text-sm text-gray-600">
            <span>Chính sách</span>
            <span class="space-x-2">
              <span class="">
                <ShieldCheckIcon className="inline" size={18} />
                Trả hàng miễn phí</span
              >
              <span>Miễn phí vẫn chuyển</span>
            </span>
          </div>
          <div>
            <ProductOptionSelect
              client:only
              product_id={product?.id || ""}
              optionData={options}
            />
          </div>

          <div class="flex gap-2">
            <AddToCartButton
              data={{ id: product?.id }}
              client:load
              className={cn(
                buttonVariants({ variant: "outline", size: "lg" }),
                "flex-1 cursor-pointer"
              )}
            />
            <BuyNowButton
              client:load
              item={{
                id: product?.id || "",
                name: product?.name || "",
                price: product?.price || 0,
                discount: product?.discount || 0,
                slug: product?.slug || "",
                thumbnail: product?.gallery?.[0],
                quantity: 1,
                selected: true,
              }}
              className={cn(buttonVariants({ size: "lg" }), "flex-1")}
            />
          </div>
        </div>
      </div>
    </div>
    <div class="bg-gray-50 py-4 px-4 lg:px-0">
      <div
        class="lg:max-w-6xl mx-auto text-sm font-semibold text-gray-700 space-x-2"
      >
        <a class="" href="#thong-tin">Thông tin sản phẩm</a>
        <a class="" href="#danh-gia">Đánh giá</a>
      </div>
    </div>
    <div>
      <div class="max-w-6xl mx-auto px-2 lg:px-0">
        <div class="content" set:html={product?.description} />
      </div>
    </div>
  </div>
</Main>
